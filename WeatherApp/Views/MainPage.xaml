<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="WeatherApp.Views.MainPage"
             Title="Weather App">

    <Grid RowDefinitions="Auto,*,Auto" Padding="20" BackgroundColor="#512BDF">

        <!-- Search Section -->
        <StackLayout Grid.Row="0" Spacing="10">
            <Label Text="Weather Forecast" FontSize="28" FontAttributes="Bold" TextColor="White" />

            <!-- Search Bar with Location Button -->
            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                <Entry Grid.Column="0"
                       x:Name="CityEntry"
                       Placeholder="Enter city name"
                       PlaceholderColor="LightGray"
                       Text="{Binding SearchCity}"
                       BackgroundColor="White"
                       TextColor="Black"
                       Padding="10"
                       CornerRadius="8" />

                <Button Grid.Column="1"
                        Text="ðŸ”"
                        Command="{Binding SearchWeatherCommand}"
                        BackgroundColor="#FF6B6B"
                        TextColor="White"
                        Padding="15,0"
                        CornerRadius="8"
                        FontSize="18" />

                <Button Grid.Column="2"
                        Text="ðŸ“"
                        Command="{Binding UseCurrentLocationCommand}"
                        BackgroundColor="#4CAF50"
                        TextColor="White"
                        Padding="15,0"
                        CornerRadius="8"
                        FontSize="18" />
            </Grid>

            <!-- History Toggle Button -->
            <Button Text="{Binding ShowSearchHistory, StringFormat='ðŸ“‹ {0}'}"
                    Command="{Binding ToggleSearchHistoryCommand}"
                    BackgroundColor="#2196F3"
                    TextColor="White"
                    Padding="20,10"
                    CornerRadius="8"
                    FontSize="14" />
        </StackLayout>

        <!-- Search History Section -->
        <ScrollView Grid.Row="1" IsVisible="{Binding ShowSearchHistory}">
            <StackLayout Padding="0,20,0,20" Spacing="10">
                <Label Text="Recent Searches"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="White" />

                <StackLayout BindableLayout.ItemsSource="{Binding SearchHistory}" Spacing="8">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Button Grid.Column="0"
                                        Text="{Binding CityName, StringFormat='ðŸ“ {0}'}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectHistoryItemCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="#6A4C93"
                                        TextColor="White"
                                        Padding="15,10"
                                        CornerRadius="8"
                                        FontSize="14"
                                        HorizontalOptions="FillAndExpand" />

                                <Button Grid.Column="1"
                                        Text="âœ•"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ClearHistoryItemCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="#FF6B6B"
                                        TextColor="White"
                                        Padding="12,10"
                                        CornerRadius="8"
                                        FontSize="14" />
                            </Grid>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>

                <Label Text="No search history yet"
                       HorizontalOptions="Center"
                       FontSize="14"
                       TextColor="White"
                       Opacity="0.7"
                       IsVisible="{Binding SearchHistory.Count, Converter={StaticResource StringToBoolConverter}, ConverterParameter=Inverted}" />
            </StackLayout>
        </ScrollView>

        <!-- Weather Content Section -->
        <ScrollView Grid.Row="1" IsVisible="{Binding ShowSearchHistory, Converter={StaticResource StringToBoolConverter}, ConverterParameter=Inverted}">
            <StackLayout Padding="0,20,0,20" Spacing="20">

                <!-- Error Message -->
                <Label Text="{Binding ErrorMessage}"
                       TextColor="#FF6B6B"
                       FontSize="14"
                       IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}" />

                <!-- Loading Indicator -->
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                   IsVisible="{Binding IsLoading}"
                                   Color="White" />

                <!-- Weather Info -->
                <Frame HasShadow="True"
                       CornerRadius="15"
                       BorderColor="White"
                       BackgroundColor="#6A4C93"
                       IsVisible="{Binding CurrentWeather, Converter={StaticResource NullToVisibilityConverter}}"
                       Padding="20">
                    <StackLayout Spacing="15">

                        <!-- Location -->
                        <Label Text="{Binding CurrentWeather.Location, StringFormat='ðŸ“ {0}'}"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="White" />

                        <!-- Device Location Indicator -->
                        <Label Text="(Using device location)"
                               FontSize="12"
                               TextColor="#FFD700"
                               IsVisible="{Binding UseDeviceLocation}" />

                        <!-- Temperature -->
                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Label Text="ðŸŒ¡ï¸" FontSize="24" VerticalOptions="Center" />
                            <Label Text="{Binding CurrentWeather.Temperature, StringFormat='{0:F1}Â°C'}"
                                   FontSize="32"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   VerticalOptions="Center" />
                        </StackLayout>

                        <!-- Description -->
                        <Label Text="{Binding CurrentWeather.Description}"
                               FontSize="16"
                               TextColor="White"
                               FontAttributes="Italic" />

                        <!-- Separator -->
                        <BoxView Color="White" HeightRequest="1" />

                        <!-- Humidity -->
                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Label Text="ðŸ’§ Humidity:" FontSize="14" TextColor="White" />
                            <Label Text="{Binding CurrentWeather.Humidity, StringFormat='{0}%'}"
                                   FontSize="14"
                                   TextColor="White" />
                        </StackLayout>

                        <!-- Wind Speed -->
                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Label Text="ðŸ’¨ Wind Speed:" FontSize="14" TextColor="White" />
                            <Label Text="{Binding CurrentWeather.WindSpeed, StringFormat='{0:F1} km/h'}"
                                   FontSize="14"
                                   TextColor="White" />
                        </StackLayout>

                        <!-- Updated Time -->
                        <Label Text="{Binding CurrentWeather.UpdatedAt, StringFormat='Last updated: {0:HH:mm:ss}'}"
                               FontSize="12"
                               TextColor="#E0E0E0" />
                    </StackLayout>
                </Frame>

                <!-- Initial Message -->
                <Label Text="Search for a city to see the weather forecast"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       FontSize="16"
                       TextColor="White"
                       IsVisible="{Binding CurrentWeather, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Inverted}"
                       Opacity="0.7" />
            </StackLayout>
        </ScrollView>

        <!-- Forecast Button -->
        <Button Grid.Row="2"
                Text="ðŸ“… View 7-Day Forecast"
                Command="{Binding GoToForecastCommand}"
                BackgroundColor="#FF9800"
                TextColor="White"
                Padding="20,15"
                CornerRadius="8"
                FontSize="16"
                IsEnabled="{Binding CurrentWeather, Converter={StaticResource NullToVisibilityConverter}}" />
    </Grid>
</ContentPage>
